<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcritor de √Åudio Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A192F; /* Deep navy blue background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .app-container {
            width: 100%;
            max-width: 600px;
            background-color: #172A45; /* Slightly lighter navy blue container background */
            border-radius: 24px; /* More rounded corners */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8); /* More intense shadow */
            padding: 32px; /* More padding */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px; /* More spacing */
            border: 1px solid rgba(255, 255, 255, 0.05); /* Subtle border */
        }
        /* Style for the logo */
        .company-logo {
            max-width: 180px; /* Max width of the logo */
            height: auto;
            margin: 0 auto 20px auto; /* Center and add bottom margin */
            display: block; /* Ensures auto margin works */
            border-radius: 8px; /* Rounded corners for the logo */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Subtle shadow for the logo */
        }
        .main-button {
            background-color: #007BFF; /* Vibrant blue for main button */
            color: #ffffff;
            font-weight: bold;
            padding: 14px;
            border-radius: 30px; /* Rounded buttons */
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 52px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        .main-button:hover {
            background-color: #0069d9; /* Darker blue on hover */
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5);
        }
        .main-button:active {
            background-color: #0056b3;
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .main-button.recording {
            background-color: #DC3545; /* Red for recording (high contrast) */
        }
        .main-button.recording:hover {
            background-color: #c82333;
        }
        .main-button.recording:active {
            background-color: #bd2130;
        }
        .llm-feature-button {
            background-color: #1E90FF; /* Lighter blue for AI features */
            color: #ffffff;
            font-weight: bold;
            padding: 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .llm-feature-button:hover {
            background-color: #1C86EE;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        .llm-feature-button:active {
            background-color: #1874CD;
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .llm-feature-button:disabled {
            background-color: #6C7A89; /* Grayish blue for disabled */
            color: #A7B9CC;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .export-button {
            background-color: #00BCD4; /* Cyan/Teal for export buttons */
            color: #ffffff;
            font-weight: bold;
            padding: 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .export-button:hover {
            background-color: #00ACC1;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        .export-button:active {
            background-color: #0097A7;
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .export-button:disabled {
            background-color: #6C7A89;
            color: #A7B9CC;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .utility-button {
            background-color: #4A6D8E; /* Darker grayish blue for utility */
            color: #ffffff;
            font-weight: bold;
            padding: 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .utility-button:hover {
            background-color: #3E5B7A;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        .utility-button:active {
            background-color: #334C66;
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .transcription-output, .partial-transcription, .llm-feature-output, .input-field {
            background-color: #213B5C; /* Dark blue background for text fields */
            border: 1px solid #4A6D8E; /* Subtle grayish blue border */
            border-radius: 12px;
            padding: 16px;
            color: #E0E6F0; /* Light blue text */
            font-size: 16px;
            white-space: pre-wrap;
            min-height: 80px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .partial-transcription {
            min-height: 40px;
            font-size: 14px;
            font-style: italic;
            color: #A7B9CC; /* Grayish blue for partial text */
        }
        .llm-feature-output {
            background-color: #2A4B70; /* Slightly lighter background for AI outputs */
            display: none;
            position: relative;
        }
        .loading-indicator {
            text-align: center;
            color: #A7B9CC;
            font-style: italic;
            display: none;
        }
        .llm-loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #1E90FF; /* Blue for spinner */
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        .title-text {
            font-size: 32px;
            font-weight: bold;
            color: #FFFFFF; /* Pure white title */
            text-align: center;
            margin-bottom: 28px;
            text-shadow: 0 0 10px rgba(0, 123, 255, 0.6); /* Subtle blue glow */
        }
        .status-message {
            text-align: center;
            color: #E0E6F0; /* Light blue status text */
            font-weight: bold;
            margin-top: 10px;
        }
        .field-label {
            font-size: 16px;
            color: #E0E6F0; /* Light blue labels */
            margin-bottom: 6px;
            font-weight: 600;
        }
        .info-text {
            font-size: 14px;
            color: #A7B9CC; /* Grayish blue info text */
            margin-top: 6px;
        }
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #00FFFF; /* Vibrant cyan for recording dot */
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            margin-left: 10px;
            vertical-align: middle;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8); /* Intense cyan glow */
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; box-shadow: 0 0 10px rgba(0, 255, 255, 0.8); }
            50% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 20px rgba(0, 255, 255, 1); }
            100% { transform: scale(0.8); opacity: 0.6; box-shadow: 0 0 10px rgba(0, 255, 255, 0.8); }
        }
        /* Style for the select input */
        .input-field {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #4A6D8E;
            background-color: #213B5C; /* Dark blue background */
            min-height: 48px;
            font-size: 16px;
            color: #E0E6F0; /* Light blue text */
            width: 100%;
            box-sizing: border-box;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        /* Style for the audio visualizer canvas */
        #audioVisualizerCanvas {
            width: 100%;
            height: 90px;
            background-color: #172A45; /* Visualizer background (same as container) */
            border-radius: 12px;
            margin-top: 15px;
            margin-bottom: 25px;
            display: none;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.7);
        }
        /* Welcome message styles */
        .welcome-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007BFF; /* Blue background */
            color: #ffffff;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
            font-size: 18px;
            font-weight: bold;
            opacity: 0; /* Starts hidden */
            transform: translateY(20px); /* Starts slightly below */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            z-index: 1000; /* Ensure it's on top */
        }
        .welcome-message.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Espa√ßo para a logo da empresa -->
        <!-- **** COLOQUE AQUI A URL DA SUA LOGO, SUBSTITUINDO 'SEU_NOME_DO_REPOSITORIO' **** -->
        <img id="companyLogo" src="logobranca.png" alt="Logo da Empresa" class="company-logo">

        <div class="title-text">Transcritor de √Åudio Completo</div>

        <p class="text-gray-400 text-sm mb-4">
            Clique no bot√£o "Iniciar Grava√ß√£o" e comece a falar. O texto aparecer√° abaixo em tempo real.
            Este recurso usa a API de Reconhecimento de Fala do seu navegador.
        </p>

        <label for="languageSelect" class="field-label">Idioma da Transcri√ß√£o:</label>
        <select id="languageSelect" class="input-field mb-4">
            <option value="pt-BR">Portugu√™s (Brasil)</option>
            <option value="en-US">Ingl√™s (Estados Unidos)</option>
            <option value="es-ES">Espanhol (Espanha)</option>
            <option value="fr-FR">Franc√™s (Fran√ßa)</option>
            <option value="de-DE">Alem√£o (Alemanha)</option>
        </select>

        <button id="buttonToggleRecording" class="main-button">Iniciar Grava√ß√£o</button>
        <div id="statusMessage" class="status-message">
            <span id="recordingDot" class="recording-indicator" style="display: none;"></span>
            <span id="statusText"></span>
        </div>

        <!-- New audio visualizer (Canvas) -->
        <canvas id="audioVisualizerCanvas"></canvas>

        <label class="field-label mt-4">Transcri√ß√£o Parcial:</label>
        <div id="partialTranscription" class="partial-transcription"></div>

        <label class="field-label mt-4">Transcri√ß√£o Final:</label>
        <div id="finalTranscription" class="transcription-output"></div>
        <div id="wordCharCount" class="info-text text-right"></div>

        <!-- AI Buttons -->
        <button id="buttonSummarizeTranscription" class="llm-feature-button mt-4" disabled>Resumir Transcri√ß√£o ‚ú®</button>
        <div id="summaryOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonTranslateTranscription" class="llm-feature-button mt-4" disabled>Traduzir para o Portugu√™s (Brasil) ‚ú®</button>
        <div id="translationOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonExtractTopics" class="llm-feature-button mt-4" disabled>Extrair T√≥picos Principais ‚ú®</button>
        <div id="topicsOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonSentimentAnalysis" class="llm-feature-button mt-4" disabled>An√°lise de Sentimento ‚ú®</button>
        <div id="sentimentOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonExtractActionItems" class="llm-feature-button mt-4" disabled>Extrair Itens de A√ß√£o ‚ú®</button>
        <div id="actionItemsOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonExtractKeywords" class="llm-feature-button mt-4" disabled>Extrair Palavras-Chave ‚ú®</button>
        <div id="keywordsOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <!-- Export and Utility Buttons -->
        <button id="buttonExportMeetingMinutes" class="export-button mt-4" disabled>Gerar e Exportar Ata de Reuni√£o (Word) üìÑ</button>
        <div id="meetingMinutesPreview" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonExportTxt" class="export-button mt-4" disabled>Exportar Transcri√ß√£o (TXT) üìù</button>

        <button id="buttonCopyTranscription" class="utility-button mt-4" disabled>Copiar Transcri√ß√£o Final üìã</button>

        <button id="buttonClearAILogic" class="utility-button mt-4">Limpar Sa√≠das de IA ‚ôªÔ∏è</button>
        <button id="buttonSaveSession" class="utility-button mt-4">Salvar Sess√£o üíæ</button>
        <button id="buttonLoadSession" class="utility-button mt-4">Carregar √öltima Sess√£o üìÇ</button>
        <button id="buttonClearAll" class="utility-button mt-4">Limpar Tudo üßπ</button>
    </div>

    <!-- Welcome Message -->
    <div id="welcomeMessage" class="welcome-message">
        Bem-vindo, Leandro!
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const buttonToggleRecording = document.getElementById('buttonToggleRecording');
            const statusMessageDiv = document.getElementById('statusMessage');
            const recordingDot = document.getElementById('recordingDot');
            const statusText = document.getElementById('statusText');
            const partialTranscription = document.getElementById('partialTranscription');
            const finalTranscription = document.getElementById('finalTranscription');
            const wordCharCount = document.getElementById('wordCharCount');

            // New elements for the audio visualizer (Canvas)
            const audioVisualizerCanvas = document.getElementById('audioVisualizerCanvas');
            const canvasCtx = audioVisualizerCanvas.getContext('2d'); // 2D context of the canvas

            // Elements for AI features
            const buttonSummarizeTranscription = document.getElementById('buttonSummarizeTranscription');
            const summaryOutput = document.getElementById('summaryOutput');
            const buttonTranslateTranscription = document.getElementById('buttonTranslateTranscription');
            const translationOutput = document.getElementById('translationOutput');
            const buttonExtractTopics = document.getElementById('buttonExtractTopics');
            const topicsOutput = document.getElementById('topicsOutput');
            const buttonSentimentAnalysis = document.getElementById('buttonSentimentAnalysis');
            const sentimentOutput = document.getElementById('sentimentOutput');
            const buttonExtractActionItems = document.getElementById('buttonExtractActionItems');
            const actionItemsOutput = document.getElementById('actionItemsOutput');
            const buttonExtractKeywords = document.getElementById('buttonExtractKeywords');
            const keywordsOutput = document.getElementById('keywordsOutput');

            // Elements for export and utility
            const buttonExportMeetingMinutes = document.getElementById('buttonExportMeetingMinutes');
            const meetingMinutesPreview = document.getElementById('meetingMinutesPreview');
            const buttonExportTxt = document.getElementById('buttonExportTxt');
            const buttonCopyTranscription = document.getElementById('buttonCopyTranscription');
            const buttonSaveSession = document.getElementById('buttonSaveSession');
            const buttonLoadSession = document.getElementById('buttonLoadSession');
            const buttonClearAILogic = document.getElementById('buttonClearAILogic');
            const buttonClearAll = document.getElementById('buttonClearAll');

            const languageSelect = document.getElementById('languageSelect');

            let recognition;
            let isRecording = false;

            // Variables for the audio visualizer
            let audioContext;
            let analyser;
            let microphoneStream;
            let animationFrameId;

            // Welcome message element
            const welcomeMessage = document.getElementById('welcomeMessage');

            // Display welcome message on load
            setTimeout(() => {
                welcomeMessage.classList.add('show');
            }, 500); // Show after 0.5 seconds

            // Hide welcome message after some time
            setTimeout(() => {
                welcomeMessage.classList.remove('show');
                // Optional: remove element from DOM after transition
                setTimeout(() => {
                    welcomeMessage.remove();
                }, 1000); // Wait for transition to finish
            }, 4000); // Hide after 4 seconds (total 4.5s including initial delay)


            // Check if the browser supports the Web Speech API
            if (!('webkitSpeechRecognition' in window)) {
                statusText.textContent = 'Desculpe, seu navegador n√£o suporta a API de Reconhecimento de Fala.';
                buttonToggleRecording.disabled = true;
                return;
            }

            // Function to start the audio visualizer
            async function startAudioVisualizer() {
                try {
                    // Request microphone access
                    microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(microphoneStream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256; // FFT size for frequency analysis (number of bars)
                    const bufferLength = analyser.frequencyBinCount; // Half of fftSize
                    const dataArray = new Uint8Array(bufferLength); // Array to store frequency data

                    source.connect(analyser);

                    audioVisualizerCanvas.style.display = 'block'; // Show the canvas
                    audioVisualizerCanvas.width = audioVisualizerCanvas.offsetWidth; // Set actual canvas width
                    audioVisualizerCanvas.height = audioVisualizerCanvas.offsetHeight; // Set actual canvas height

                    const barWidth = (audioVisualizerCanvas.width / bufferLength) * 2.5; // Width of each bar
                    let x = 0;

                    function draw() {
                        animationFrameId = requestAnimationFrame(draw);

                        analyser.getByteFrequencyData(dataArray); // Get frequency data

                        canvasCtx.clearRect(0, 0, audioVisualizerCanvas.width, audioVisualizerCanvas.height); // Clear the canvas
                        canvasCtx.fillStyle = '#172A45'; /* Visualizer background (same as container) */
                        canvasCtx.fillRect(0, 0, audioVisualizerCanvas.width, audioVisualizerCanvas.height); // Draw the background

                        x = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            let barHeight = dataArray[i]; // Bar height is the frequency value

                            // Gradient of dark blue to light blue/cyan, with a subtle glow
                            let gradient = canvasCtx.createLinearGradient(0, audioVisualizerCanvas.height, 0, audioVisualizerCanvas.height - barHeight);
                            gradient.addColorStop(0, '#007BFF'); // Vibrant blue at the base
                            gradient.addColorStop(0.5, '#1E90FF'); // Medium blue
                            gradient.addColorStop(1, '#00FFFF'); // Vibrant cyan at the top (for glow)
                            canvasCtx.fillStyle = gradient;

                            // Draw the bar (x, y, width, height)
                            // Add slight rounding to the top of the bars
                            canvasCtx.beginPath();
                            canvasCtx.roundRect(x, audioVisualizerCanvas.height - barHeight, barWidth, barHeight, 3); /* Rounded corners */
                            canvasCtx.fill();

                            x += barWidth + 1; // Space between bars
                        }
                    }
                    draw();
                } catch (err) {
                    console.error('Error accessing microphone for visualization:', err);
                    statusText.textContent = 'Erro ao acessar o microfone para visualiza√ß√£o. Verifique as permiss√µes.';
                    audioVisualizerCanvas.style.display = 'none'; // Hide if error
                }
            }

            // Function to stop the audio visualizer
            function stopAudioVisualizer() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                if (microphoneStream) {
                    microphoneStream.getTracks().forEach(track => track.stop());
                }
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                }
                audioVisualizerCanvas.style.display = 'none'; // Hide visualizer
                canvasCtx.clearRect(0, 0, audioVisualizerCanvas.width, audioVisualizerCanvas.height); // Clear canvas
            }

            // Function to initialize/reinitialize SpeechRecognition with the selected language
            function initializeRecognition() {
                if (recognition) {
                    recognition.onstart = null;
                    recognition.onresult = null;
                    recognition.onend = null;
                    recognition.onerror = null;
                }
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = languageSelect.value;

                recognition.onstart = function() {
                    isRecording = true;
                    buttonToggleRecording.textContent = 'Parar Grava√ß√£o';
                    buttonToggleRecording.classList.add('recording');
                    recordingDot.style.display = 'inline-block';
                    statusText.textContent = 'Gravando... Fale agora.';
                    clearAllOutputs();
                    startAudioVisualizer(); // Start visualizer
                };

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    partialTranscription.textContent = interimTranscript;
                    finalTranscription.textContent += finalTranscript + ' ';
                    updateWordCharCount();
                };

                recognition.onend = function() {
                    isRecording = false;
                    buttonToggleRecording.textContent = 'Iniciar Grava√ß√£o';
                    buttonToggleRecording.classList.remove('recording');
                    recordingDot.style.display = 'none';
                    statusText.textContent = 'Grava√ß√£o Parada.';
                    partialTranscription.textContent = '';
                    stopAudioVisualizer(); // Stop visualizer

                    if (finalTranscription.textContent.trim().length > 0) {
                        buttonSummarizeTranscription.disabled = false;
                        buttonTranslateTranscription.disabled = false;
                        buttonExtractTopics.disabled = false;
                        buttonSentimentAnalysis.disabled = false;
                        buttonExtractActionItems.disabled = false;
                        buttonExtractKeywords.disabled = false;
                        buttonExportTxt.disabled = false;
                        buttonCopyTranscription.disabled = false;
                        buttonSaveSession.disabled = false;
                        buttonClearAILogic.disabled = false;
                    }
                };

                recognition.onerror = function(event) {
                    isRecording = false;
                    buttonToggleRecording.textContent = 'Iniciar Grava√ß√£o';
                    buttonToggleRecording.classList.remove('recording');
                    recordingDot.style.display = 'none';
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'not-allowed') {
                        statusText.textContent = 'Permiss√£o do microfone negada. Por favor, permita o acesso ao microfone nas configura√ß√µes do navegador.';
                    } else if (event.error === 'no-speech') {
                        statusText.textContent = 'Nenhuma fala detectada. Tente novamente.';
                    } else {
                        statusText.textContent = `Erro: ${event.error}. Tente novamente.`;
                    }
                    // Disable AI and export buttons on error
                    buttonSummarizeTranscription.disabled = true;
                    buttonTranslateTranscription.disabled = true;
                    buttonExtractTopics.disabled = true;
                    buttonSentimentAnalysis.disabled = true;
                    buttonExtractActionItems.disabled = true;
                    buttonExtractKeywords.disabled = true;
                    buttonExportMeetingMinutes.disabled = true;
                    buttonExportTxt.disabled = true;
                    buttonCopyTranscription.disabled = true;
                    buttonSaveSession.disabled = true;
                    buttonClearAILogic.disabled = true;
                    stopAudioVisualizer(); // Stop visualizer on error
                };
            }

            // Initialize recognition for the first time
            initializeRecognition();

            // Event listener for language change
            languageSelect.addEventListener('change', function() {
                if (isRecording) {
                    recognition.stop();
                }
                initializeRecognition();
                clearAllOutputs();
                statusText.textContent = `Idioma da transcri√ß√£o alterado para ${languageSelect.options[languageSelect.selectedIndex].text}.`;
            });

            // Function to call Gemini API for text processing
            async function callGeminiApiForTextProcessing(prompt, outputElement, loadingSpinner) {
                loadingSpinner.style.display = 'inline-block';
                outputElement.querySelector('.llm-output-text').textContent = '';
                outputElement.style.display = 'block';

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                // **** COLOQUE AQUI SUA CHAVE DE API GEMINI ****
                // Voc√™ pode obter uma chave em https://aistudio.google.com/
                const apiKey = "AIzaSyCnPYQjh4Q1qpkOVnCoPflKck1cSf7hHfc"; // <-- SUA CHAVE DE API FOI INSERIDA AQUI

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Erro da API: ${response.status} - ${errorData.error.message || 'Erro desconhecido'}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        outputElement.querySelector('.llm-output-text').textContent = text;
                        
                        if (outputElement === topicsOutput && text.trim().length > 0 && finalTranscription.textContent.trim().length > 0) {
                            buttonExportMeetingMinutes.disabled = false;
                        }

                    } else {
                        outputElement.querySelector('.llm-output-text').textContent = 'N√£o foi poss√≠vel gerar uma resposta. Por favor, tente novamente.';
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    outputElement.querySelector('.llm-output-text').textContent = `Erro: ${error.message}. Verifique o console para mais detalhes.`;
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            // Function to generate and export meeting minutes
            async function generateMeetingMinutesAndExport() {
                const transcription = finalTranscription.textContent.trim();
                const topics = topicsOutput.querySelector('.llm-output-text').textContent.trim();

                if (transcription === '') {
                    alert('Nenhuma transcri√ß√£o final dispon√≠vel para gerar a ata da reuni√£o.');
                    return;
                }
                if (topics === '') {
                    alert('Por favor, extraia os t√≥picos principais antes de gerar a ata da reuni√£o.');
                    return;
                }

                const currentDate = new Date().toLocaleDateString('pt-BR');
                const currentTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                const prompt = `Format the following text and topics into meeting minutes. Include a title "Meeting Minutes", the current date and time (${currentDate} ${currentTime}), a section for "Topics Covered" (using the provided topics), and a section for "Full Transcription". Use a clear and professional format for the minutes.\n\nTranscription:\n${transcription}\n\nMain Topics:\n${topics}`;

                meetingMinutesPreview.style.display = 'none';
                meetingMinutesPreview.querySelector('.llm-output-text').textContent = '';
                const meetingMinutesSpinner = meetingMinutesPreview.querySelector('.llm-loading-spinner');
                
                await callGeminiApiForTextProcessing(prompt, meetingMinutesPreview, meetingMinutesSpinner);
                const meetingMinutesContent = meetingMinutesPreview.querySelector('.llm-output-text').textContent;

                if (meetingMinutesContent) {
                    const htmlContent = `
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <title>Ata de Reuni√£o</title>
                            <style>
                                body { font-family: 'Times New Roman', Times, serif; margin: 1in; }
                                h1 { text-align: center; font-size: 24pt; margin-bottom: 20pt; }
                                h2 { font-size: 16pt; margin-top: 20pt; margin-bottom: 10pt; }
                                p { font-size: 12pt; line-height: 1.5; margin-bottom: 10pt; }
                                ul { list-style-type: disc; margin-left: 20pt; }
                                li { font-size: 12pt; line-height: 1.5; margin-bottom: 5pt; }
                            </style>
                        </head>
                        <body>
                            ${meetingMinutesContent.replace(/\n/g, '<br>')}
                        </body>
                        </html>
                    `;
                    const blob = new Blob([htmlContent], { type: 'application/msword' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Ata_Reuniao_${currentDate.replace(/\//g, '-')}_${currentTime.replace(/:/g, '-')}.doc`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    alert('Ata de reuni√£o gerada e download iniciado!');
                } else {
                    alert('N√£o foi poss√≠vel gerar o conte√∫do da ata da reuni√£o.');
                }
            }

            // Function to export text to TXT
            function exportTextToTxt(filename, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Function to copy text to clipboard
            function copyToClipboard(text) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => alert('Copiado para a √°rea de transfer√™ncia!'))
                        .catch(err => {
                            console.error('Erro ao copiar:', err);
                            alert('N√£o foi poss√≠vel copiar. Tente manualmente.');
                        });
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        alert('Copiado para a √°rea de transfer√™ncia!');
                    } catch (err) {
                        console.error('Erro ao copiar (execCommand):', err);
                        alert('N√£o foi poss√≠vel copiar. Tente manualmente.');
                    }
                    document.body.removeChild(textarea);
                }
            }

            // Function to update word and character count
            function updateWordCharCount() {
                const text = finalTranscription.textContent.trim();
                const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
                const charCount = text.length;
                wordCharCount.textContent = `Palavras: ${wordCount} | Caracteres: ${charCount}`;
            }

            // Function to clear only AI outputs
            function clearAILogicOutputs() {
                summaryOutput.querySelector('.llm-output-text').textContent = '';
                summaryOutput.style.display = 'none';
                translationOutput.querySelector('.llm-output-text').textContent = '';
                translationOutput.style.display = 'none';
                topicsOutput.querySelector('.llm-output-text').textContent = '';
                topicsOutput.style.display = 'none';
                sentimentOutput.querySelector('.llm-output-text').textContent = '';
                sentimentOutput.style.display = 'none';
                actionItemsOutput.querySelector('.llm-output-text').textContent = '';
                actionItemsOutput.style.display = 'none';
                keywordsOutput.querySelector('.llm-output-text').textContent = '';
                keywordsOutput.style.display = 'none';
                meetingMinutesPreview.querySelector('.llm-output-text').textContent = '';
                meetingMinutesPreview.style.display = 'none';

                // Disable AI and meeting minutes export buttons
                buttonSummarizeTranscription.disabled = true;
                buttonTranslateTranscription.disabled = true;
                buttonExtractTopics.disabled = true;
                buttonSentimentAnalysis.disabled = true;
                buttonExtractActionItems.disabled = true;
                buttonExtractKeywords.disabled = true;
                buttonExportMeetingMinutes.disabled = true;
                buttonClearAILogic.disabled = true;
            }

            // Function to clear all fields and outputs
            function clearAllOutputs() {
                partialTranscription.textContent = '';
                finalTranscription.textContent = '';
                wordCharCount.textContent = '';
                statusText.textContent = '';
                recordingDot.style.display = 'none';
                
                clearAILogicOutputs(); // Call function to clear AI outputs

                buttonExportTxt.disabled = true;
                buttonCopyTranscription.disabled = true;
                buttonSaveSession.disabled = true;
            }

            // Function to save session to localStorage
            function saveSession() {
                const sessionData = {
                    finalTranscription: finalTranscription.textContent,
                    summaryOutput: summaryOutput.querySelector('.llm-output-text').textContent,
                    translationOutput: translationOutput.querySelector('.llm-output-text').textContent,
                    topicsOutput: topicsOutput.querySelector('.llm-output-text').textContent,
                    sentimentOutput: sentimentOutput.querySelector('.llm-output-text').textContent,
                    actionItemsOutput: actionItemsOutput.querySelector('.llm-output-text').textContent,
                    keywordsOutput: keywordsOutput.querySelector('.llm-output-text').textContent
                };
                localStorage.setItem('transcriptionSession', JSON.stringify(sessionData));
                alert('Sess√£o salva com sucesso!');
            }

            // Function to load session from localStorage
            function loadSession() {
                const savedData = localStorage.getItem('transcriptionSession');
                if (savedData) {
                    const sessionData = JSON.parse(savedData);
                    clearAllOutputs(); // Clear before loading

                    finalTranscription.textContent = sessionData.finalTranscription || '';
                    summaryOutput.querySelector('.llm-output-text').textContent = sessionData.summaryOutput || '';
                    translationOutput.querySelector('.llm-output-text').textContent = sessionData.translationOutput || '';
                    topicsOutput.querySelector('.llm-output-text').textContent = sessionData.topicsOutput || '';
                    sentimentOutput.querySelector('.llm-output-text').textContent = sessionData.sentimentOutput || '';
                    actionItemsOutput.querySelector('.llm-output-text').textContent = sessionData.actionItemsOutput || '';
                    keywordsOutput.querySelector('.llm-output-text').textContent = sessionData.keywordsOutput || '';

                    // Display outputs if content exists
                    if (summaryOutput.querySelector('.llm-output-text').textContent) summaryOutput.style.display = 'block';
                    if (translationOutput.querySelector('.llm-output-text').textContent) translationOutput.style.display = 'block';
                    if (topicsOutput.querySelector('.llm-output-text').textContent) topicsOutput.style.display = 'block';
                    if (sentimentOutput.querySelector('.llm-output-text').textContent) sentimentOutput.style.display = 'block';
                    if (actionItemsOutput.querySelector('.llm-output-text').textContent) actionItemsOutput.style.display = 'block';
                    if (keywordsOutput.querySelector('.llm-output-text').textContent) keywordsOutput.style.display = 'block';

                    // Re-enable buttons based on loaded content
                    if (finalTranscription.textContent.trim().length > 0) {
                        buttonSummarizeTranscription.disabled = false;
                        buttonTranslateTranscription.disabled = false;
                        buttonExtractTopics.disabled = false;
                        buttonSentimentAnalysis.disabled = false;
                        buttonExtractActionItems.disabled = false;
                        buttonExtractKeywords.disabled = false;
                        buttonExportTxt.disabled = false;
                        buttonCopyTranscription.disabled = false;
                        buttonSaveSession.disabled = false;
                        buttonClearAILogic.disabled = false;
                        if (topicsOutput.querySelector('.llm-output-text').textContent.trim().length > 0) {
                            buttonExportMeetingMinutes.disabled = false;
                        }
                    }
                    updateWordCharCount();
                    alert('Sess√£o carregada com sucesso!');
                } else {
                    alert('Nenhuma sess√£o salva encontrada.');
                }
            }

            // Event listener for toggle recording button
            buttonToggleRecording.addEventListener('click', function() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    statusText.textContent = 'Iniciando grava√ß√£o...';
                    recognition.start();
                }
            });

            // Event listeners for AI buttons
            buttonSummarizeTranscription.addEventListener('click', function() {
                const textToSummarize = finalTranscription.textContent.trim();
                if (textToSummarize === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para resumir.'); return; }
                const prompt = `Resuma o seguinte texto de forma concisa e clara:\n\n${textToSummarize}`;
                callGeminiApiForTextProcessing(prompt, summaryOutput, summaryOutput.querySelector('.llm-loading-spinner'));
            });

            buttonTranslateTranscription.addEventListener('click', function() {
                const textToTranslate = finalTranscription.textContent.trim();
                if (textToTranslate === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para traduzir.'); return; }
                const prompt = `Traduza o seguinte texto para o portugu√™s do Brasil:\n\n${textToTranslate}`;
                callGeminiApiForTextProcessing(prompt, translationOutput, translationOutput.querySelector('.llm-loading-spinner'));
            });

            buttonExtractTopics.addEventListener('click', function() {
                const textToAnalyze = finalTranscription.textContent.trim();
                if (textToAnalyze === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para extrair t√≥picos.'); return; }
                const prompt = `Analise o seguinte texto e liste de 3 a 5 t√≥picos ou assuntos principais abordados, separados por marcadores:\n\n${textToAnalyze}`;
                callGeminiApiForTextProcessing(prompt, topicsOutput, topicsOutput.querySelector('.llm-loading-spinner'));
            });

            buttonSentimentAnalysis.addEventListener('click', function() {
                const textToAnalyze = finalTranscription.textContent.trim();
                if (textToAnalyze === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para an√°lise de sentimento.'); return; }
                const prompt = `Analise o sentimento geral do seguinte texto e classifique-o como Positivo, Negativo ou Neutro. Explique brevemente o porqu√™:\n\n${textToAnalyze}`;
                callGeminiApiForTextProcessing(prompt, sentimentOutput, sentimentOutput.querySelector('.llm-loading-spinner'));
            });

            buttonExtractActionItems.addEventListener('click', function() {
                const textToAnalyze = finalTranscription.textContent.trim();
                if (textToAnalyze === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para extrair itens de a√ß√£o.'); return; }
                const prompt = `Do texto a seguir, extraia todos os itens de a√ß√£o, tarefas ou pr√≥ximos passos que foram mencionados. Liste-os com marcadores:\n\n${textToAnalyze}`;
                callGeminiApiForTextProcessing(prompt, actionItemsOutput, actionItemsOutput.querySelector('.llm-loading-spinner'));
            });

            buttonExtractKeywords.addEventListener('click', function() {
                const textToAnalyze = finalTranscription.textContent.trim();
                if (textToAnalyze === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para extrair palavras-chave.'); return; }
                const prompt = `Liste as 5 a 10 palavras-chave ou frases mais relevantes do texto a seguir:\n\n${textToAnalyze}`;
                callGeminiApiForTextProcessing(prompt, keywordsOutput, keywordsOutput.querySelector('.llm-loading-spinner'));
            });

            // Event listener for Generate and Export Meeting Minutes button
            buttonExportMeetingMinutes.addEventListener('click', generateMeetingMinutesAndExport);

            // Event listener for Export Transcription (TXT) button
            buttonExportTxt.addEventListener('click', function() {
                const textToExport = finalTranscription.textContent.trim();
                if (textToExport === '') { alert('Nenhuma transcri√ß√£o final para exportar.'); return; }
                const filename = `transcricao_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.txt`;
                exportTextToTxt(filename, textToExport);
                alert('Transcri√ß√£o exportada como TXT!');
            });

            // Event listener for Copy Final Transcription button
            buttonCopyTranscription.addEventListener('click', function() {
                const textToCopy = finalTranscription.textContent.trim();
                if (textToCopy === '') { alert('Nenhuma transcri√ß√£o final para copiar.'); return; }
                copyToClipboard(textToCopy);
            });

            // Event listener for Save Session button
            buttonSaveSession.addEventListener('click', saveSession);

            // Event listener for Load Session button
            buttonLoadSession.addEventListener('click', loadSession);

            // New Event listener for Clear AI Outputs button
            buttonClearAILogic.addEventListener('click', clearAILogicOutputs);

            // Event listener for Clear All button
            buttonClearAll.addEventListener('click', clearAllOutputs);
        });
    </script>
</body>
</html>
