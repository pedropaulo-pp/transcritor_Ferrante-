<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcritor de √Åudio Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A192F; /* Fundo azul marinho profundo */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .app-container {
            width: 100%;
            max-width: 600px;
            background-color: #172A45; /* Fundo do container azul marinho ligeiramente mais claro */
            border-radius: 24px; /* Cantos mais arredondados */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8); /* Sombra mais intensa */
            padding: 32px; /* Mais padding */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px; /* Mais espa√ßamento */
            border: 1px solid rgba(255, 255, 255, 0.05); /* Borda sutil */
        }
        /* Estilo para a logo */
        .company-logo {
            max-width: 180px; /* Tamanho m√°ximo da logo */
            height: auto;
            margin: 0 auto 20px auto; /* Centraliza e adiciona margem inferior */
            display: block; /* Garante que a margem auto funcione */
            border-radius: 8px; /* Cantos arredondados para a logo */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Sombra sutil para a logo */
        }
        .main-button {
            background-color: #007BFF; /* Azul vibrante para o bot√£o principal */
            color: #ffffff;
            font-weight: bold;
            padding: 14px;
            border-radius: 30px; /* Bot√µes arredondados */
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 52px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        .main-button:hover {
            background-color: #0069d9; /* Azul mais escuro no hover */
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5);
        }
        .main-button:active {
            background-color: #0056b3;
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .main-button.recording {
            background-color: #DC3545; /* Vermelho para gravar (alto contraste) */
        }
        .main-button.recording:hover {
            background-color: #c82333;
        }
        .main-button.recording:active {
            background-color: #bd2130;
        }
        .llm-feature-button {
            background-color: #1E90FF; /* Azul mais claro para recursos de IA */
            color: #ffffff;
            font-weight: bold;
            padding: 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .llm-feature-button:hover {
            background-color: #1C86EE;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        .llm-feature-button:active {
            background-color: #1874CD;
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .llm-feature-button:disabled {
            background-color: #6C7A89; /* Azul acinzentado para desabilitado */
            color: #A7B9CC;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .export-button {
            background-color: #00BCD4; /* Ciano/Teal para bot√µes de exporta√ß√£o */
            color: #ffffff;
            font-weight: bold;
            padding: 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .export-button:hover {
            background-color: #00ACC1;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        .export-button:active {
            background-color: #0097A7;
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .export-button:disabled {
            background-color: #6C7A89;
            color: #A7B9CC;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .utility-button {
            background-color: #4A6D8E; /* Azul acinzentado mais escuro para utilit√°rios */
            color: #ffffff;
            font-weight: bold;
            padding: 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .utility-button:hover {
            background-color: #3E5B7A;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        .utility-button:active {
            background-color: #334C66;
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .transcription-output, .partial-transcription, .llm-feature-output, .input-field {
            background-color: #213B5C; /* Fundo azul escuro para campos de texto */
            border: 1px solid #4A6D8E; /* Borda azul acinzentada sutil */
            border-radius: 12px;
            padding: 16px;
            color: #E0E6F0; /* Texto azul claro */
            font-size: 16px;
            white-space: pre-wrap;
            min-height: 80px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .partial-transcription {
            min-height: 40px;
            font-size: 14px;
            font-style: italic;
            color: #A7B9CC; /* Azul acinzentado para texto parcial */
        }
        .llm-feature-output {
            background-color: #2A4B70; /* Fundo ligeiramente mais claro para sa√≠das de IA */
            display: none;
            position: relative;
        }
        .loading-indicator {
            text-align: center;
            color: #A7B9CC;
            font-style: italic;
            display: none;
        }
        .llm-loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #1E90FF; /* Azul para o spinner */
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        .title-text {
            font-size: 32px;
            font-weight: bold;
            color: #FFFFFF; /* T√≠tulo branco puro */
            text-align: center;
            margin-bottom: 28px;
            text-shadow: 0 0 10px rgba(0, 123, 255, 0.6); /* Brilho azul sutil */
        }
        .status-message {
            text-align: center;
            color: #E0E6F0; /* Texto de status azul claro */
            font-weight: bold;
            margin-top: 10px;
        }
        .field-label {
            font-size: 16px;
            color: #E0E6F0; /* Labels azul claro */
            margin-bottom: 6px;
            font-weight: 600;
        }
        .info-text {
            font-size: 14px;
            color: #A7B9CC; /* Texto informativo azul acinzentado */
            margin-top: 6px;
        }
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #00FFFF; /* Ciano vibrante para o ponto de grava√ß√£o */
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            margin-left: 10px;
            vertical-align: middle;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8); /* Brilho ciano intenso */
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; box-shadow: 0 0 10px rgba(0, 255, 255, 0.8); }
            50% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 20px rgba(0, 255, 255, 1); }
            100% { transform: scale(0.8); opacity: 0.6; box-shadow: 0 0 10px rgba(0, 255, 255, 0.8); }
        }
        /* Estilo para o select */
        .input-field {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #4A6D8E;
            background-color: #213B5C; /* Fundo azul escuro */
            min-height: 48px;
            font-size: 16px;
            color: #E0E6F0; /* Texto azul claro */
            width: 100%;
            box-sizing: border-box;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        /* Estilo para o canvas visualizador */
        #audioVisualizerCanvas {
            width: 100%;
            height: 90px;
            background-color: #172A45; /* Fundo do visualizador (mesmo do container) */
            border-radius: 12px;
            margin-top: 15px;
            margin-bottom: 25px;
            display: none;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Espa√ßo para a logo da empresa -->
      <img id="companyLogo" src="./logobranca.png" alt="Logo da Empresa" class="company-logo">
        <div class="title-text">Transcritor de √Åudio Completo</div>

        <p class="text-gray-400 text-sm mb-4">
            Clique no bot√£o "Iniciar Grava√ß√£o" e comece a falar. O texto aparecer√° abaixo em tempo real.
            Este recurso utiliza a API de Reconhecimento de Fala do seu navegador.
        </p>

        <label for="languageSelect" class="field-label">Idioma da Transcri√ß√£o:</label>
        <select id="languageSelect" class="input-field mb-4">
            <option value="pt-BR">Portugu√™s (Brasil)</option>
            <option value="en-US">Ingl√™s (Estados Unidos)</option>
            <option value="es-ES">Espanhol (Espanha)</option>
            <option value="fr-FR">Franc√™s (Fran√ßa)</option>
            <option value="de-DE">Alem√£o (Alemanha)</option>
        </select>

        <button id="buttonToggleRecording" class="main-button">Iniciar Grava√ß√£o</button>
        <div id="statusMessage" class="status-message">
            <span id="recordingDot" class="recording-indicator" style="display: none;"></span>
            <span id="statusText"></span>
        </div>

        <!-- Novo visualizador de √°udio (Canvas) -->
        <canvas id="audioVisualizerCanvas"></canvas>

        <label class="field-label mt-4">Transcri√ß√£o Parcial:</label>
        <div id="partialTranscription" class="partial-transcription"></div>

        <label class="field-label mt-4">Transcri√ß√£o Final:</label>
        <div id="finalTranscription" class="transcription-output"></div>
        <div id="wordCharCount" class="info-text text-right"></div>

        <!-- Bot√µes de IA -->
        <button id="buttonSummarizeTranscription" class="llm-feature-button mt-4" disabled>Resumir Transcri√ß√£o ‚ú®</button>
        <div id="summaryOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonTranslateTranscription" class="llm-feature-button mt-4" disabled>Traduzir para Ingl√™s ‚ú®</button>
        <div id="translationOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonExtractTopics" class="llm-feature-button mt-4" disabled>Extrair T√≥picos Principais ‚ú®</button>
        <div id="topicsOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonSentimentAnalysis" class="llm-feature-button mt-4" disabled>An√°lise de Sentimento ‚ú®</button>
        <div id="sentimentOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonExtractActionItems" class="llm-feature-button mt-4" disabled>Extrair Itens de A√ß√£o ‚ú®</button>
        <div id="actionItemsOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonExtractKeywords" class="llm-feature-button mt-4" disabled>Extrair Palavras-Chave ‚ú®</button>
        <div id="keywordsOutput" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <!-- Bot√µes de Exporta√ß√£o e Utilidade -->
        <button id="buttonExportMeetingMinutes" class="export-button mt-4" disabled>Gerar e Exportar Ata de Reuni√£o (Word) üìÑ</button>
        <div id="meetingMinutesPreview" class="llm-feature-output">
            <span class="llm-loading-spinner" style="display: none;"></span>
            <span class="llm-output-text"></span>
        </div>

        <button id="buttonExportTxt" class="export-button mt-4" disabled>Exportar Transcri√ß√£o (TXT) üìù</button>

        <button id="buttonCopyTranscription" class="utility-button mt-4" disabled>Copiar Transcri√ß√£o Final üìã</button>

        <button id="buttonClearAILogic" class="utility-button mt-4">Limpar Sa√≠das de IA ‚ôªÔ∏è</button>
        <button id="buttonSaveSession" class="utility-button mt-4">Salvar Sess√£o üíæ</button>
        <button id="buttonLoadSession" class="utility-button mt-4">Carregar √öltima Sess√£o üìÇ</button>
        <button id="buttonClearAll" class="utility-button mt-4">Limpar Tudo üßπ</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const buttonToggleRecording = document.getElementById('buttonToggleRecording');
            const statusMessageDiv = document.getElementById('statusMessage');
            const recordingDot = document.getElementById('recordingDot');
            const statusText = document.getElementById('statusText');
            const partialTranscription = document.getElementById('partialTranscription');
            const finalTranscription = document.getElementById('finalTranscription');
            const wordCharCount = document.getElementById('wordCharCount');

            // Novos elementos para o visualizador de √°udio (Canvas)
            const audioVisualizerCanvas = document.getElementById('audioVisualizerCanvas');
            const canvasCtx = audioVisualizerCanvas.getContext('2d'); // Contexto 2D do canvas

            // Elementos para os recursos de IA
            const buttonSummarizeTranscription = document.getElementById('buttonSummarizeTranscription');
            const summaryOutput = document.getElementById('summaryOutput');
            const buttonTranslateTranscription = document.getElementById('buttonTranslateTranscription');
            const translationOutput = document.getElementById('translationOutput');
            const buttonExtractTopics = document.getElementById('buttonExtractTopics');
            const topicsOutput = document.getElementById('topicsOutput');
            const buttonSentimentAnalysis = document.getElementById('buttonSentimentAnalysis');
            const sentimentOutput = document.getElementById('sentimentOutput');
            const buttonExtractActionItems = document.getElementById('buttonExtractActionItems');
            const actionItemsOutput = document.getElementById('actionItemsOutput');
            const buttonExtractKeywords = document.getElementById('buttonExtractKeywords');
            const keywordsOutput = document.getElementById('keywordsOutput');

            // Elementos para exporta√ß√£o e utilidade
            const buttonExportMeetingMinutes = document.getElementById('buttonExportMeetingMinutes');
            const meetingMinutesPreview = document.getElementById('meetingMinutesPreview');
            const buttonExportTxt = document.getElementById('buttonExportTxt');
            const buttonCopyTranscription = document.getElementById('buttonCopyTranscription');
            const buttonSaveSession = document.getElementById('buttonSaveSession');
            const buttonLoadSession = document.getElementById('buttonLoadSession');
            const buttonClearAILogic = document.getElementById('buttonClearAILogic');
            const buttonClearAll = document.getElementById('buttonClearAll');

            const languageSelect = document.getElementById('languageSelect');

            let recognition;
            let isRecording = false;

            // Vari√°veis para o visualizador de √°udio
            let audioContext;
            let analyser;
            let microphoneStream;
            let animationFrameId;

            // Verifica se o navegador suporta a Web Speech API
            if (!('webkitSpeechRecognition' in window)) {
                statusText.textContent = 'Desculpe, seu navegador n√£o suporta a API de Reconhecimento de Fala.';
                buttonToggleRecording.disabled = true;
                return;
            }

            // Fun√ß√£o para iniciar o visualizador de √°udio
            async function startAudioVisualizer() {
                try {
                    // Solicita acesso ao microfone
                    microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(microphoneStream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256; // Tamanho do FFT para an√°lise de frequ√™ncia (n√∫mero de barras)
                    const bufferLength = analyser.frequencyBinCount; // Metade do fftSize
                    const dataArray = new Uint8Array(bufferLength); // Array para armazenar os dados de frequ√™ncia

                    source.connect(analyser);

                    audioVisualizerCanvas.style.display = 'block'; // Mostra o canvas
                    audioVisualizerCanvas.width = audioVisualizerCanvas.offsetWidth; // Define a largura real do canvas
                    audioVisualizerCanvas.height = audioVisualizerCanvas.offsetHeight; // Define a altura real do canvas

                    const barWidth = (audioVisualizerCanvas.width / bufferLength) * 2.5; // Largura de cada barra
                    let x = 0;

                    function draw() {
                        animationFrameId = requestAnimationFrame(draw);

                        analyser.getByteFrequencyData(dataArray); // Obt√©m os dados de frequ√™ncia

                        canvasCtx.clearRect(0, 0, audioVisualizerCanvas.width, audioVisualizerCanvas.height); // Limpa o canvas
                        canvasCtx.fillStyle = '#172A45'; /* Fundo do visualizador (mesmo do container) */
                        canvasCtx.fillRect(0, 0, audioVisualizerCanvas.width, audioVisualizerCanvas.height); // Desenha o fundo

                        x = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            let barHeight = dataArray[i]; // A altura da barra √© o valor da frequ√™ncia

                            // Gradiente de azul escuro para azul claro/ciana, com um brilho sutil
                            let gradient = canvasCtx.createLinearGradient(0, audioVisualizerCanvas.height, 0, audioVisualizerCanvas.height - barHeight);
                            gradient.addColorStop(0, '#007BFF'); // Azul vibrante na base
                            gradient.addColorStop(0.5, '#1E90FF'); // Azul m√©dio
                            gradient.addColorStop(1, '#00FFFF'); // Ciano vibrante no topo (para o brilho)
                            canvasCtx.fillStyle = gradient;

                            // Desenha a barra (x, y, largura, altura)
                            // Adiciona um pequeno arredondamento no topo das barras
                            canvasCtx.beginPath();
                            canvasCtx.roundRect(x, audioVisualizerCanvas.height - barHeight, barWidth, barHeight, 3); /* Cantos arredondados */
                            canvasCtx.fill();

                            x += barWidth + 1; // Espa√ßo entre as barras
                        }
                    }
                    draw();
                } catch (err) {
                    console.error('Erro ao acessar o microfone para visualiza√ß√£o:', err);
                    statusText.textContent = 'Erro ao acessar o microfone para visualiza√ß√£o. Verifique as permiss√µes.';
                    audioVisualizerCanvas.style.display = 'none'; // Oculta se houver erro
                }
            }

            // Fun√ß√£o para parar o visualizador de √°udio
            function stopAudioVisualizer() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                if (microphoneStream) {
                    microphoneStream.getTracks().forEach(track => track.stop());
                }
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                }
                audioVisualizerCanvas.style.display = 'none'; // Oculta o visualizador
                canvasCtx.clearRect(0, 0, audioVisualizerCanvas.width, audioVisualizerCanvas.height); // Limpa o canvas
            }

            // Fun√ß√£o para inicializar/reinicializar o SpeechRecognition com o idioma selecionado
            function initializeRecognition() {
                if (recognition) {
                    recognition.onstart = null;
                    recognition.onresult = null;
                    recognition.onend = null;
                    recognition.onerror = null;
                }
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = languageSelect.value;

                recognition.onstart = function() {
                    isRecording = true;
                    buttonToggleRecording.textContent = 'Parar Grava√ß√£o';
                    buttonToggleRecording.classList.add('recording');
                    recordingDot.style.display = 'inline-block';
                    statusText.textContent = 'Gravando... Fale agora.';
                    clearAllOutputs();
                    startAudioVisualizer(); // Inicia o visualizador
                };

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    partialTranscription.textContent = interimTranscript;
                    finalTranscription.textContent += finalTranscript + ' ';
                    updateWordCharCount();
                };

                recognition.onend = function() {
                    isRecording = false;
                    buttonToggleRecording.textContent = 'Iniciar Grava√ß√£o';
                    buttonToggleRecording.classList.remove('recording');
                    recordingDot.style.display = 'none';
                    statusText.textContent = 'Grava√ß√£o Parada.';
                    partialTranscription.textContent = '';
                    stopAudioVisualizer(); // Para o visualizador

                    if (finalTranscription.textContent.trim().length > 0) {
                        buttonSummarizeTranscription.disabled = false;
                        buttonTranslateTranscription.disabled = false;
                        buttonExtractTopics.disabled = false;
                        buttonSentimentAnalysis.disabled = false;
                        buttonExtractActionItems.disabled = false;
                        buttonExtractKeywords.disabled = false;
                        buttonExportTxt.disabled = false;
                        buttonCopyTranscription.disabled = false;
                        buttonSaveSession.disabled = false;
                        buttonClearAILogic.disabled = false;
                    }
                };

                recognition.onerror = function(event) {
                    isRecording = false;
                    buttonToggleRecording.textContent = 'Iniciar Grava√ß√£o';
                    buttonToggleRecording.classList.remove('recording');
                    recordingDot.style.display = 'none';
                    console.error('Erro no reconhecimento de fala:', event.error);
                    if (event.error === 'not-allowed') {
                        statusText.textContent = 'Permiss√£o do microfone negada. Por favor, permita o acesso ao microfone nas configura√ß√µes do navegador.';
                    } else if (event.error === 'no-speech') {
                        statusText.textContent = 'Nenhuma fala detectada. Tente novamente.';
                    } else {
                        statusText.textContent = `Erro: ${event.error}. Tente novamente.`;
                    }
                    // Desabilita bot√µes de IA e exporta√ß√£o em caso de erro
                    buttonSummarizeTranscription.disabled = true;
                    buttonTranslateTranscription.disabled = true;
                    buttonExtractTopics.disabled = true;
                    buttonSentimentAnalysis.disabled = true;
                    buttonExtractActionItems.disabled = true;
                    buttonExtractKeywords.disabled = true;
                    buttonExportMeetingMinutes.disabled = true;
                    buttonExportTxt.disabled = true;
                    buttonCopyTranscription.disabled = true;
                    buttonSaveSession.disabled = true;
                    buttonClearAILogic.disabled = true;
                    stopAudioVisualizer(); // Para o visualizador em caso de erro
                };
            }

            // Inicializa o reconhecimento pela primeira vez
            initializeRecognition();

            // Event listener para mudan√ßa de idioma
            languageSelect.addEventListener('change', function() {
                if (isRecording) {
                    recognition.stop();
                }
                initializeRecognition();
                clearAllOutputs();
                statusText.textContent = `Idioma de transcri√ß√£o alterado para ${languageSelect.options[languageSelect.selectedIndex].text}.`;
            });

            // Fun√ß√£o para chamar a API Gemini para processamento de texto
            async function callGeminiApiForTextProcessing(prompt, outputElement, loadingSpinner) {
                loadingSpinner.style.display = 'inline-block';
                outputElement.querySelector('.llm-output-text').textContent = '';
                outputElement.style.display = 'block';

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Erro na API: ${response.status} - ${errorData.error.message || 'Erro desconhecido'}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        outputElement.querySelector('.llm-output-text').textContent = text;
                        
                        if (outputElement === topicsOutput && text.trim().length > 0 && finalTranscription.textContent.trim().length > 0) {
                            buttonExportMeetingMinutes.disabled = false;
                        }

                    } else {
                        outputElement.querySelector('.llm-output-text').textContent = 'N√£o foi poss√≠vel gerar uma resposta. Tente novamente.';
                    }
                } catch (error) {
                    console.error('Erro ao chamar a API Gemini:', error);
                    outputElement.querySelector('.llm-output-text').textContent = `Erro: ${error.message}. Verifique o console para mais detalhes.`;
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            // Fun√ß√£o para gerar e exportar a ata de reuni√£o
            async function generateMeetingMinutesAndExport() {
                const transcription = finalTranscription.textContent.trim();
                const topics = topicsOutput.querySelector('.llm-output-text').textContent.trim();

                if (transcription === '') {
                    alert('Nenhuma transcri√ß√£o final dispon√≠vel para gerar a ata.');
                    return;
                }
                if (topics === '') {
                    alert('Por favor, extraia os t√≥picos principais antes de gerar a ata.');
                    return;
                }

                const currentDate = new Date().toLocaleDateString('pt-BR');
                const currentTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                const prompt = `Formate o seguinte texto e t√≥picos em uma ata de reuni√£o. Inclua um t√≠tulo "Ata de Reuni√£o", a data e hora atual (${currentDate} ${currentTime}), uma se√ß√£o para "T√≥picos Abordados" (usando os t√≥picos fornecidos) e uma se√ß√£o para "Transcri√ß√£o Completa". Use um formato claro e profissional para a ata.\n\nTranscri√ß√£o:\n${transcription}\n\nT√≥picos Principais:\n${topics}`;

                meetingMinutesPreview.style.display = 'none';
                meetingMinutesPreview.querySelector('.llm-output-text').textContent = '';
                const meetingMinutesSpinner = meetingMinutesPreview.querySelector('.llm-loading-spinner');
                
                await callGeminiApiForTextProcessing(prompt, meetingMinutesPreview, meetingMinutesSpinner);
                const meetingMinutesContent = meetingMinutesPreview.querySelector('.llm-output-text').textContent;

                if (meetingMinutesContent) {
                    const htmlContent = `
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <title>Ata de Reuni√£o</title>
                            <style>
                                body { font-family: 'Times New Roman', Times, serif; margin: 1in; }
                                h1 { text-align: center; font-size: 24pt; margin-bottom: 20pt; }
                                h2 { font-size: 16pt; margin-top: 20pt; margin-bottom: 10pt; }
                                p { font-size: 12pt; line-height: 1.5; margin-bottom: 10pt; }
                                ul { list-style-type: disc; margin-left: 20pt; }
                                li { font-size: 12pt; line-height: 1.5; margin-bottom: 5pt; }
                            </style>
                        </head>
                        <body>
                            ${meetingMinutesContent.replace(/\n/g, '<br>')}
                        </body>
                        </html>
                    `;
                    const blob = new Blob([htmlContent], { type: 'application/msword' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Ata_Reuniao_${currentDate.replace(/\//g, '-')}_${currentTime.replace(/:/g, '-')}.doc`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    alert('Ata de reuni√£o gerada e download iniciado!');
                } else {
                    alert('N√£o foi poss√≠vel gerar o conte√∫do da ata de reuni√£o.');
                }
            }

            // Fun√ß√£o para exportar texto para TXT
            function exportTextToTxt(filename, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Fun√ß√£o para copiar texto para a √°rea de transfer√™ncia
            function copyToClipboard(text) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => alert('Copiado para a √°rea de transfer√™ncia!'))
                        .catch(err => {
                            console.error('Erro ao copiar:', err);
                            alert('N√£o foi poss√≠vel copiar. Tente manualmente.');
                        });
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        alert('Copiado para a √°rea de transfer√™ncia!');
                    } catch (err) {
                        console.error('Erro ao copiar (execCommand):', err);
                        alert('N√£o foi poss√≠vel copiar. Tente manualmente.');
                    }
                    document.body.removeChild(textarea);
                }
            }

            // Fun√ß√£o para atualizar a contagem de palavras e caracteres
            function updateWordCharCount() {
                const text = finalTranscription.textContent.trim();
                const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
                const charCount = text.length;
                wordCharCount.textContent = `Palavras: ${wordCount} | Caracteres: ${charCount}`;
            }

            // Fun√ß√£o para limpar apenas as sa√≠das de IA
            function clearAILogicOutputs() {
                summaryOutput.querySelector('.llm-output-text').textContent = '';
                summaryOutput.style.display = 'none';
                translationOutput.querySelector('.llm-output-text').textContent = '';
                translationOutput.style.display = 'none';
                topicsOutput.querySelector('.llm-output-text').textContent = '';
                topicsOutput.style.display = 'none';
                sentimentOutput.querySelector('.llm-output-text').textContent = '';
                sentimentOutput.style.display = 'none';
                actionItemsOutput.querySelector('.llm-output-text').textContent = '';
                actionItemsOutput.style.display = 'none';
                keywordsOutput.querySelector('.llm-output-text').textContent = '';
                keywordsOutput.style.display = 'none';
                meetingMinutesPreview.querySelector('.llm-output-text').textContent = '';
                meetingMinutesPreview.style.display = 'none';

                // Desabilitar bot√µes de IA e exporta√ß√£o de ata
                buttonSummarizeTranscription.disabled = true;
                buttonTranslateTranscription.disabled = true;
                buttonExtractTopics.disabled = true;
                buttonSentimentAnalysis.disabled = true;
                buttonExtractActionItems.disabled = true;
                buttonExtractKeywords.disabled = true;
                buttonExportMeetingMinutes.disabled = true;
                buttonClearAILogic.disabled = true;
            }

            // Fun√ß√£o para limpar todos os campos e sa√≠das
            function clearAllOutputs() {
                partialTranscription.textContent = '';
                finalTranscription.textContent = '';
                wordCharCount.textContent = '';
                statusText.textContent = '';
                recordingDot.style.display = 'none';
                
                clearAILogicOutputs(); // Chama a fun√ß√£o para limpar as sa√≠das de IA

                buttonExportTxt.disabled = true;
                buttonCopyTranscription.disabled = true;
                buttonSaveSession.disabled = true;
            }

            // Fun√ß√£o para salvar a sess√£o no localStorage
            function saveSession() {
                const sessionData = {
                    finalTranscription: finalTranscription.textContent,
                    summaryOutput: summaryOutput.querySelector('.llm-output-text').textContent,
                    translationOutput: translationOutput.querySelector('.llm-output-text').textContent,
                    topicsOutput: topicsOutput.querySelector('.llm-output-text').textContent,
                    sentimentOutput: sentimentOutput.querySelector('.llm-output-text').textContent,
                    actionItemsOutput: actionItemsOutput.querySelector('.llm-output-text').textContent,
                    keywordsOutput: keywordsOutput.querySelector('.llm-output-text').textContent
                };
                localStorage.setItem('transcriptionSession', JSON.stringify(sessionData));
                alert('Sess√£o salva com sucesso!');
            }

            // Fun√ß√£o para carregar a sess√£o do localStorage
            function loadSession() {
                const savedData = localStorage.getItem('transcriptionSession');
                if (savedData) {
                    const sessionData = JSON.parse(savedData);
                    clearAllOutputs(); // Limpa antes de carregar

                    finalTranscription.textContent = sessionData.finalTranscription || '';
                    summaryOutput.querySelector('.llm-output-text').textContent = sessionData.summaryOutput || '';
                    translationOutput.querySelector('.llm-output-text').textContent = sessionData.translationOutput || '';
                    topicsOutput.querySelector('.llm-output-text').textContent = sessionData.topicsOutput || '';
                    sentimentOutput.querySelector('.llm-output-text').textContent = sessionData.sentimentOutput || '';
                    actionItemsOutput.querySelector('.llm-output-text').textContent = sessionData.actionItemsOutput || '';
                    keywordsOutput.querySelector('.llm-output-text').textContent = sessionData.keywordsOutput || '';

                    // Exibir sa√≠das se houver conte√∫do
                    if (summaryOutput.querySelector('.llm-output-text').textContent) summaryOutput.style.display = 'block';
                    if (translationOutput.querySelector('.llm-output-text').textContent) translationOutput.style.display = 'block';
                    if (topicsOutput.querySelector('.llm-output-text').textContent) topicsOutput.style.display = 'block';
                    if (sentimentOutput.querySelector('.llm-output-text').textContent) sentimentOutput.style.display = 'block';
                    if (actionItemsOutput.querySelector('.llm-output-text').textContent) actionItemsOutput.style.display = 'block';
                    if (keywordsOutput.querySelector('.llm-output-text').textContent) keywordsOutput.style.display = 'block';

                    // Reabilitar bot√µes com base no conte√∫do carregado
                    if (finalTranscription.textContent.trim().length > 0) {
                        buttonSummarizeTranscription.disabled = false;
                        buttonTranslateTranscription.disabled = false;
                        buttonExtractTopics.disabled = false;
                        buttonSentimentAnalysis.disabled = false;
                        buttonExtractActionItems.disabled = false;
                        buttonExtractKeywords.disabled = false;
                        buttonExportTxt.disabled = false;
                        buttonCopyTranscription.disabled = false;
                        buttonSaveSession.disabled = false;
                        buttonClearAILogic.disabled = false;
                        if (topicsOutput.querySelector('.llm-output-text').textContent.trim().length > 0) {
                            buttonExportMeetingMinutes.disabled = false;
                        }
                    }
                    updateWordCharCount();
                    alert('Sess√£o carregada com sucesso!');
                } else {
                    alert('Nenhuma sess√£o salva encontrada.');
                }
            }

            // Event listener para o bot√£o de iniciar/parar grava√ß√£o
            buttonToggleRecording.addEventListener('click', function() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    statusText.textContent = 'Iniciando grava√ß√£o...';
                    recognition.start();
                }
            });

            // Event listeners para os bot√µes de IA
            buttonSummarizeTranscription.addEventListener('click', function() {
                const textToSummarize = finalTranscription.textContent.trim();
                if (textToSummarize === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para resumir.'); return; }
                const prompt = `Resuma o seguinte texto de forma concisa e clara:\n\n${textToSummarize}`;
                callGeminiApiForTextProcessing(prompt, summaryOutput, summaryOutput.querySelector('.llm-loading-spinner'));
            });

            buttonTranslateTranscription.addEventListener('click', function() {
                const textToTranslate = finalTranscription.textContent.trim();
                if (textToTranslate === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para traduzir.'); return; }
                const prompt = `Traduza o seguinte texto do portugu√™s para o ingl√™s:\n\n${textToTranslate}`;
                callGeminiApiForTextProcessing(prompt, translationOutput, translationOutput.querySelector('.llm-loading-spinner'));
            });

            buttonExtractTopics.addEventListener('click', function() {
                const textToAnalyze = finalTranscription.textContent.trim();
                if (textToAnalyze === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para extrair t√≥picos.'); return; }
                const prompt = `Analise o seguinte texto e liste os 3 a 5 principais t√≥picos ou assuntos abordados, separando-os por marcadores:\n\n${textToAnalyze}`;
                callGeminiApiForTextProcessing(prompt, topicsOutput, topicsOutput.querySelector('.llm-loading-spinner'));
            });

            buttonSentimentAnalysis.addEventListener('click', function() {
                const textToAnalyze = finalTranscription.textContent.trim();
                if (textToAnalyze === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para an√°lise de sentimento.'); return; }
                const prompt = `Analise o sentimento geral do seguinte texto e classifique-o como Positivo, Negativo ou Neutro. Explique brevemente o porqu√™:\n\n${textToAnalyze}`;
                callGeminiApiForTextProcessing(prompt, sentimentOutput, sentimentOutput.querySelector('.llm-loading-spinner'));
            });

            buttonExtractActionItems.addEventListener('click', function() {
                const textToAnalyze = finalTranscription.textContent.trim();
                if (textToAnalyze === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para extrair itens de a√ß√£o.'); return; }
                const prompt = `Do seguinte texto, extraia todos os itens de a√ß√£o, tarefas ou pr√≥ximos passos que foram mencionados. Liste-os com marcadores:\n\n${textToAnalyze}`;
                callGeminiApiForTextProcessing(prompt, actionItemsOutput, actionItemsOutput.querySelector('.llm-loading-spinner'));
            });

            buttonExtractKeywords.addEventListener('click', function() {
                const textToAnalyze = finalTranscription.textContent.trim();
                if (textToAnalyze === '') { alert('Nenhuma transcri√ß√£o final dispon√≠vel para extrair palavras-chave.'); return; }
                const prompt = `Liste as 5 a 10 palavras-chave ou frases mais relevantes do seguinte texto:\n\n${textToAnalyze}`;
                callGeminiApiForTextProcessing(prompt, keywordsOutput, keywordsOutput.querySelector('.llm-loading-spinner'));
            });

            // Event listener para o bot√£o Gerar e Exportar Ata de Reuni√£o
            buttonExportMeetingMinutes.addEventListener('click', generateMeetingMinutesAndExport);

            // Event listener para o bot√£o Exportar Transcri√ß√£o (TXT)
            buttonExportTxt.addEventListener('click', function() {
                const textToExport = finalTranscription.textContent.trim();
                if (textToExport === '') { alert('Nenhuma transcri√ß√£o final para exportar.'); return; }
                const filename = `transcricao_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.txt`;
                exportTextToTxt(filename, textToExport);
                alert('Transcri√ß√£o exportada como TXT!');
            });

            // Event listener para o bot√£o Copiar Transcri√ß√£o Final
            buttonCopyTranscription.addEventListener('click', function() {
                const textToCopy = finalTranscription.textContent.trim();
                if (textToCopy === '') { alert('Nenhuma transcri√ß√£o final para copiar.'); return; }
                copyToClipboard(textToCopy);
            });

            // Event listener para o bot√£o Salvar Sess√£o
            buttonSaveSession.addEventListener('click', saveSession);

            // Event listener para o bot√£o Carregar Sess√£o
            buttonLoadSession.addEventListener('click', loadSession);

            // Novo Event listener para o bot√£o Limpar Sa√≠das de IA
            buttonClearAILogic.addEventListener('click', clearAILogicOutputs);

            // Event listener para o bot√£o Limpar Tudo
            buttonClearAll.addEventListener('click', clearAllOutputs);
        });
    </script>
</body>
</html>
